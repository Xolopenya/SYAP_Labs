<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ETL Producer - Отправка данных в Kafka</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display:flex; justify-content:center; align-items:center;
      padding:20px;
    }
    .container {
      background:white; border-radius:10px;
      box-shadow:0 10px 40px rgba(0,0,0,0.3);
      width:100%; max-width:600px; overflow:hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:white; padding:30px; text-align:center;
    }
    .header h1 { font-size:28px; margin-bottom:10px; }
    .header p { opacity:.9; font-size:14px; }

    .tabs { display:flex; background:#f5f5f5; border-bottom:1px solid #ddd; }
    .tab-button {
      flex:1; padding:15px; border:none; background:#f5f5f5;
      cursor:pointer; font-size:14px; font-weight:500; color:#666;
      transition: all .3s ease;
    }
    .tab-button.active { background:#fff; color:#667eea; border-bottom:3px solid #667eea; }
    .tab-button:hover { background:#fff; }

    .content { padding:30px; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }

    .form-group { margin-bottom:20px; }
    label { display:block; margin-bottom:8px; font-weight:500; color:#333; }

    input[type="text"], input[type="file"], textarea, select {
      width:100%; padding:10px; border:1px solid #ddd; border-radius:5px;
      font-size:14px; font-family:inherit; transition:border-color .3s ease;
    }
    input[type="text"]:focus, textarea:focus, select:focus {
      outline:none; border-color:#667eea;
      box-shadow:0 0 0 3px rgba(102,126,234,.1);
    }
    textarea { resize:vertical; min-height:120px; }

    .columns-section {
      background:#f9f9f9; padding:15px; border-radius:5px; margin-bottom:20px;
    }
    .column-item { display:flex; gap:10px; margin-bottom:10px; }
    .column-item input { flex:1; }
    .column-item select { flex:1; }

    .btn-remove {
      padding:8px 12px; background:#ff6b6b; color:white; border:none;
      border-radius:5px; cursor:pointer; font-size:12px;
    }
    .btn-add {
      padding:8px 15px; background:#51cf66; color:white; border:none;
      border-radius:5px; cursor:pointer; font-size:14px; margin-bottom:15px;
    }
    .btn-submit {
      width:100%; padding:12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:white; border:none; border-radius:5px; font-size:16px; font-weight:600;
      cursor:pointer;
    }
    .message {
      padding:12px 15px; border-radius:5px; margin-bottom:20px; display:none;
    }
    .message.success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; display:block; }
    .message.error { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; display:block; }

    .info-box {
      background:#e7f3ff; border-left:4px solid #2196F3; padding:12px;
      margin-bottom:20px; border-radius:3px; font-size:13px; color:#1976D2;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ETL Producer</h1>
      <p>Отправка данных в Kafka</p>
    </div>

    <div class="tabs">
      <button class="tab-button active" onclick="switchTab(0)">Ручной ввод</button>
      <button class="tab-button" onclick="switchTab(1)">Загрузить файл</button>
    </div>

    <div class="content">
      <div class="tab-content active">
        <div id="message" class="message"></div>

        <div class="info-box">
          Введите название таблицы, определите столбцы и добавьте данные
        </div>

        <form id="manualForm">
          <div class="form-group">
            <label for="tableName">Название таблицы:</label>
            <input type="text" id="tableName" placeholder="Например: users" required />
          </div>

          <div class="columns-section">
            <label>Столбцы:</label>
            <div id="columnsList"></div>
            <button type="button" class="btn-add" onclick="addColumn()">+ Добавить столбец</button>
          </div>

          <div class="form-group">
            <label for="jsonData">Данные (JSON):</label>
            <textarea id="jsonData" placeholder='[{"id": 1, "name": "Alice"}, {"id": 2, "name": "Bob"}]' required></textarea>
          </div>

          <button type="submit" class="btn-submit">Отправить данные в Kafka</button>
        </form>
      </div>


      <div class="tab-content">
        <div id="fileMessage" class="message"></div>

        <div class="info-box">
          Загрузите CSV файл (с заголовками)
        </div>

        <form id="fileForm">
          <div class="form-group">
            <label for="tableName2">Название таблицы:</label>
            <input type="text" id="tableName2" placeholder="Например: medicine" required />
          </div>

          <div class="form-group">
            <label for="csvFile">CSV файл:</label>
            <input type="file" id="csvFile" accept=".csv" required />
          </div>

          <button type="submit" class="btn-submit">Отправить CSV в Kafka</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    addColumn();

    function switchTab(tabIndex) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-content')[tabIndex].classList.add('active');
      document.querySelectorAll('.tab-button')[tabIndex].classList.add('active');
    }

    function addColumn() {
      const columnsList = document.getElementById('columnsList');
      const html = `
        <div class="column-item">
          <input type="text" placeholder="Название столбца" class="col-name">
          <select class="col-type">
            <option value="TEXT">TEXT</option>
            <option value="INTEGER">INTEGER</option>
            <option value="NUMERIC">NUMERIC</option>
            <option value="DATE">DATE</option>
            <option value="TIMESTAMP">TIMESTAMP</option>
            <option value="BOOLEAN">BOOLEAN</option>
          </select>
          <button type="button" class="btn-remove" onclick="this.parentElement.remove()">Удалить</button>
        </div>
      `;
      columnsList.insertAdjacentHTML('beforeend', html);
    }

    document.getElementById('manualForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const tableName = document.getElementById('tableName').value.trim();
      const jsonData = document.getElementById('jsonData').value;
      const columns = [];

      document.querySelectorAll('#columnsList .column-item').forEach(item => {
        const name = item.querySelector('.col-name').value.trim();
        const type = item.querySelector('.col-type').value;
        if (name) columns.push({ name, type });
      });

      if (!tableName || columns.length === 0 || !jsonData) {
        showMessage('Заполните все поля', false);
        return;
      }

      try {
        const rows = JSON.parse(jsonData);
        if (!Array.isArray(rows)) throw new Error('Данные должны быть массивом');

        const response = await fetch('/api/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ table: tableName, columns, rows })
        });

        const result = await response.json();
        showMessage(result.message || result.error, response.ok);

      } catch (error) {
        showMessage('Ошибка: ' + error.message, false);
      }
    });

    function showMessage(text, success) {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = 'message ' + (success ? 'success' : 'error');
      setTimeout(() => msg.className = 'message', 5000);
    }

    document.getElementById('fileForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const tableName = document.getElementById('tableName2').value.trim();
      const fileInput = document.getElementById('csvFile');
      const file = fileInput.files[0];

      if (!tableName || !file) {
        const msg = document.getElementById('fileMessage');
        msg.textContent = 'Укажите таблицу и выберите CSV файл';
        msg.className = 'message error';
        return;
      }

      const formData = new FormData();
      formData.append('table', tableName);
      formData.append('file', file);

      const resp = await fetch('/api/send-csv', {
        method: 'POST',
        body: formData
      });

      const result = await resp.json();
      const msg = document.getElementById('fileMessage');
      msg.textContent = result.message || result.error;
      msg.className = 'message ' + (resp.ok ? 'success' : 'error');
    });
  </script>
</body>
</html>
